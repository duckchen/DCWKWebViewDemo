$(function() {
        var lockBodyTop = 0;
	var scrollTop = $("body").scrollTop();
	$("#showBuy").on("click", function() {
		$("#coverPage").show();
		$("#whereToBuy").show();
                lockBodyscroll();
                window.location.href = "showbuy://"
	});
	$("#cancel").on("click", function() {
		$("#coverPage").hide();
		$("#whereToBuy").hide();
		$("body").css({
			"overflow": "auto",
			"top": "auto"
		})
                unlockBodyscroll();
	});
        $('.tarBar .btnLeft').click(function(){
            var displayFlag = document.getElementById('whereToBuy').style.display;
            if ('block' == displayFlag)
            {
                $('#weixinTip').hide();
            }else{
                $('#weixinTip').hide();
                $("#coverPage").hide(); 
                unlockBodyscroll();
            }
        });
	$("#showPost").on("click", function() {
		$("#coverPage").show();
		$("#showPrint").show();
                lockBodyscroll();
                window.location.href = "showpost://";
	});
	$("#closeBtn").on("click", function() {
		$("#coverPage").hide();
		$("#showPrint").hide();
                unlockBodyscroll();
	});
	$(".toWeixin").on("click", function() {
		$("#coverPage").show();
		$("#weixinTip").show();
                lockBodyscroll();
                window.location.href = "toweixin://"
	});
	$("#closeTip").on("click", function() {
		$("#coverPage").hide();
		$("#weixinTip").hide();
                unlockBodyscroll();
	});
        $(window).on('orientationchange', function(){
            var $weixin = $('#weixinTip');
            var $body = $('body');
            setTimeout(function(){
                adapterWidth()
            }, 300);
        });
        openWeixin();
        adapterWidth();
        hidePrintbtn();
	stopDrop()
});

function stopDrop() {
	var lastY;
	$(document.body).on("touchstart", function(event) {
		lastY = event.originalEvent.changedTouches[0].clientY
	});
	$(document.body).on("touchmove", function(event) {
		var y = event.originalEvent.changedTouches[0].clientY;
		var st = $(this).scrollTop();
		if (y >= lastY && st <= 10) {
			lastY = y;
			event.preventDefault()
		}
		lastY = y
	})
};
        function openWeixin() {
                var sUserAgent = navigator.userAgent.toLowerCase();
                var bIsIpad = sUserAgent.match(/ipad/i) == "ipad";
                var bIsIphoneOs = sUserAgent.match(/iphone os/i) == "iphone os";
                var bIsMidp = sUserAgent.match(/midp/i) == "midp";
                var bIsUc7 = sUserAgent.match(/rv:1.2.3.4/i) == "rv:1.2.3.4";
                var bIsUc = sUserAgent.match(/ucweb/i) == "ucweb";
                var bIsAndroid = sUserAgent.match(/android/i) == "android";
                var bIsCE = sUserAgent.match(/windows ce/i) == "windows ce";
                var bIsWM = sUserAgent.match(/windows mobile/i) == "windows mobile";
                if ((bIsIpad || bIsIphoneOs || bIsMidp || bIsUc7 || bIsUc || bIsAndroid || bIsCE || bIsWM))
                {
                    $('.tarBar .btnRight').attr('href', 'weixin://');             
                }
        }

        function lockBodyscroll()
        {
            lockBodyTop=$(window).scrollTop();
            $('body').lockBodyTop = lockBodyTop;
            $("body").css({
                overflow:"hidden",
                'top': lockBodyTop*-1
            });

            $('body').attr("ontouchmove", "event.preventDefault()");
        }

        function unlockBodyscroll()
        {
            $(window).scrollTop = lockBodyTop;
            $("body").css({ position:"", overflow:"", height:"", top:"" }); 
            document.documentElement.scrollTop = lockBodyTop; 
            document.body.scrollTop = lockBodyTop; 

            $('body').removeAttr("ontouchmove");
        }
        function copy(obj)
        {
             var title = $(obj).html();
             var textToCb = "片片家庭相册";
             var flag = false;
             if (window.clipboardData) {
                  window.clipboardData.setData ("Text", textToCb);
                  flag = true;
             }
             else
             { 
                  var forExecElement = CreateEelementCmd (textToCb);console.log(forExecElement);
                  SelectContent (forExecElement); 
                  var supported = true;
                  try{
                      flag = document.execCommand ("copy", false, null);  
                  } catch (e) {
                      flag = false;
                  }
             }
             document.body.removeChild (forExecElement);
             if (flag){
                 $(obj).html('复制成功');
             }else{
                 $(obj).html('复制失败');
             }
             
             setTimeout(function(){
                 $(obj).html(title);
             }, 3000);
        }
        function CreateEelementCmd(textToCb)
        {
            var ExecElement = document.createElement ("div");
            ExecElement.style.position = 'absolute';
            ExecElement.textContent = textToCb;
            document.body.appendChild(ExecElement);
            return ExecElement;
        }
        function SelectContent (element) {
            var rangeToSelect = document.createRange ();console.log(rangeToSelect);
            rangeToSelect.selectNodeContents (element);console.log(rangeToSelect);
 
            var selection = window.getSelection();
            selection.removeAllRanges ();
            selection.addRange (rangeToSelect);console.log(selection);
        }
        function adapterWidth()
        {
            var tipWidth = $('#weixinTip').width();
            var bodyWidth = $('body').width();
            var topLeft = (1 - tipWidth/bodyWidth) / 2 * 100 + '%';
            $('#weixinTip').css('left', topLeft); 
            $('#whereToBuy').css('left', topLeft); 
            $('#showPrint').css('left', topLeft); 
        }
        function hidePrintbtn(){
            var urlParam = getReparam();
            var isLogin = urlParam.isLogin;
            if('false' == isLogin)
            {
                $('.printbtn').hide();
                $('.explain').css('margin-bottom', '0');
            }else{
                $('.printbtn').show();
                $('.explain').css('margin-bottom', '6rem');
            }
        }
        function getReparam()
        {
            var urlParamobj = new Object();

            var url = window.location.search;
            if (url.indexOf('?') != -1)
            {
                var urlStr = url.substr(1);
                urlParam = urlStr.split('&');
                for(var i=0; i<urlParam.length; i++)
                {
                    var paramKey = urlParam[i].split('=')[0];
                    var paramValue = unescape(urlParam[i].split('=')[1]);
                    urlParamobj[paramKey] = paramValue;
                }
             }

             return urlParamobj;
        }
